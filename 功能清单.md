# GNOME 象棋（Xiangqi）功能清单

## 中国象棋与国际象棋的主要区别

1. **棋盘结构**：
   - 10行9列的棋盘（而非8×8）
   - 有河界（"楚河汉界"）将棋盘分为南北两部分
   - 有九宫格区域限制将帅移动

2. **棋子类型**：
   - 将/帅（将军/帅）- 类似于国王，但限制在九宫格内移动
   - 士/仕（士大夫）- 类似于有限制的主教，只能在九宫格内斜走一步
   - 象/相（大象）- 田字格移动，不能过河
   - 马（马）- 类似于国际象棋的马，但有"蹩马腿"规则
   - 车（战车）- 与国际象棋的车相同
   - 炮（火炮）- 独特的棋子，移动时直走，但吃子时需要一个棋子作为"炮台"
   - 兵/卒（士兵）- 只能向前移动，过河后可以横向移动

3. **规则特点**：
   - 将帅不能直接对面（将军面对面）
   - 特殊的"照面"规则
   - 没有王车易位
   - 没有兵的升变规则

## 需要实现的功能

### 核心游戏功能

1. **棋盘与棋子**
   - [x] 10×9棋盘的绘制，包括楚河汉界和九宫格
   - [x] 7种不同类型棋子的绘制和动画
   - [x] 红黑两方棋子的区分

2. **游戏规则**
   - [x] 所有棋子的移动规则实现
   - [x] 将军、将死和困毙判定
   - [x] 特殊规则：将帅不能对面
   - [ ] 重复局面和长将规则

3. **游戏流程**
   - [x] 游戏开始、结束判定
   - [x] 轮流走子机制
   - [x] 计时系统
   - [x] 悔棋功能

### 用户界面

1. **主界面**
   - [x] 棋盘视图
   - [x] 菜单栏和工具栏
   - [x] 状态栏显示当前状态

2. **对局控制**
   - [x] 新游戏对话框
   - [ ] 保存/加载游戏
   - [x] 设置对话框
   - [x] 历史记录面板

3. **视觉效果**
   - [ ] 棋子移动动画
   - [x] 高亮显示可移动位置
   - [x] 选中棋子效果
   - [x] 将军提示效果

### AI功能

1. **AI引擎**
   - [ ] 集成象棋AI引擎（如象棋巫师引擎）
   - [ ] 不同难度级别设置
   - [ ] AI思考时间控制

2. **AI配置**
   - [ ] AI引擎选择
   - [ ] 难度设置
   - [ ] 自定义AI参数

### 其他功能

1. **记谱系统**
   - [x] 中文记谱法（如"炮二平五"）
   - [ ] 坐标记谱法
   - [ ] 棋谱导入导出

2. **辅助功能**
   - [x] 键盘控制（快捷键）
   - [ ] 无障碍功能
   - [ ] 本地化支持

3. **扩展功能**
   - [ ] 网络对战（可选）
   - [ ] 棋谱分析（可选）
   - [ ] 残局练习（可选）

## 文件结构规划

基于gnome-chess的结构，我们需要创建以下目录和文件：

```
gnome-xiangqi/
├── data/                           # 资源文件
│   ├── xiangqi-window.ui           # 主窗口UI定义
│   ├── xiangqi.gresource.xml       # 资源配置
│   ├── engines.conf                # 引擎配置
│   ├── help-overlay.ui             # 帮助覆盖UI
│   ├── meson.build                 # 构建脚本
│   ├── new-game-dialog.ui          # 新游戏对话框UI
│   ├── org.gnome.Xiangqi.appdata.xml.in  # 应用数据
│   ├── org.gnome.Xiangqi.desktop.in      # 桌面入口
│   ├── org.gnome.Xiangqi.gschema.xml     # 应用设置
│   ├── org.gnome.Xiangqi.service.in      # 服务定义
│   ├── preferences-dialog.ui       # 首选项对话框UI
│   ├── promotion-type-selector.ui  # 升变选择器UI（可能不需要）
│   ├── icons/                      # 图标资源
│   └── pieces/                     # 棋子图像
│
├── doc/                            # 文档
│
├── engine/                         # 引擎相关代码
│   ├── ai-profile.vala             # AI配置文件
│   ├── xiangqi-engine-cecp.vala    # CECP协议引擎
│   ├── xiangqi-engine-uci.vala     # UCI协议引擎
│   ├── xiangqi-engine.vala         # 引擎基类
│   └── meson.build                 # 构建脚本
│
├── help/                           # 帮助文档
│   ├── LINGUAS                     # 语言列表
│   ├── meson.build                 # 构建脚本
│   └── C/                          # 英文帮助
│
├── lib/                            # 核心库
│   ├── xiangqi-bitboard.vala       # 位棋盘实现（可选）
│   ├── xiangqi-clock.vala          # 时钟实现
│   ├── xiangqi-game.vala           # 游戏核心逻辑
│   ├── xiangqi-move.vala           # 走子规则和记录
│   ├── xiangqi-pgn.vala            # 棋谱格式支持
│   ├── xiangqi-piece.vala          # 棋子类型和属性
│   ├── xiangqi-player.vala         # 玩家实现
│   ├── xiangqi-state.vala          # 棋盘状态管理
│   ├── config.vapi                 # 配置接口
│   └── meson.build                 # 构建脚本
│
├── po/                             # 翻译文件
│   ├── LINGUAS                     # 语言列表
│   ├── POTFILES.in                 # 需要翻译的文件列表
│   ├── meson.build                 # 构建脚本
│   └── zh_CN.po                    # 中文翻译
│
├── src/                            # 主程序源码
│   ├── xiangqi-scene.vala          # 场景渲染
│   ├── xiangqi-view.vala           # 视图控制
│   ├── xiangqi-window.vala         # 主窗口
│   ├── config.vapi                 # 配置接口
│   ├── gnome-xiangqi.vala          # 主程序入口
│   ├── meson.build                 # 构建脚本
│   ├── new-game-dialog.vala        # 新游戏对话框
│   ├── preferences-dialog.vala     # 首选项对话框
│   ├── preferences.vala            # 设置管理
│   └── promotion-type-selector-dialog.vala  # 升变选择器对话框（可能不需要）
│
├── tests/                          # 测试代码
│   └── meson.build                 # 构建脚本
│
├── build-aux/                      # 构建辅助脚本
│   └── meson/                      # Meson构建脚本
│       └── postinstall.py          # 安装后脚本
│
├── COPYING                         # 许可证文件
├── gnome-xiangqi.doap              # 项目描述
├── meson.build                     # 主构建脚本
├── NEWS                            # 新闻/更新日志
├── org.gnome.Xiangqi.json          # Flatpak清单
└── README.md                       # 项目说明
```

### 核心文件命名对应关系

根据gnome-chess的命名风格，我们的核心文件应该如下命名：

1. **核心游戏逻辑（lib/目录）**
   - `xiangqi-game.vala` - 对应chess-game.vala，游戏核心逻辑
   - `xiangqi-move.vala` - 对应chess-move.vala，走子规则和记录
   - `xiangqi-piece.vala` - 对应chess-piece.vala，棋子类型和属性
   - `xiangqi-state.vala` - 对应chess-state.vala，棋盘状态管理
   - `xiangqi-player.vala` - 对应chess-player.vala，玩家实现
   - `xiangqi-clock.vala` - 对应chess-clock.vala，时钟实现
   - `xiangqi-pgn.vala` - 对应chess-pgn.vala，棋谱格式支持

2. **UI组件（src/目录）**
   - `xiangqi-scene.vala` - 对应chess-scene.vala，场景渲染
   - `xiangqi-view.vala` - 对应chess-view.vala，视图控制
   - `xiangqi-window.vala` - 对应chess-window.vala，主窗口
   - `gnome-xiangqi.vala` - 对应gnome-chess.vala，主程序入口

3. **对话框和设置（src/目录）**
   - `new-game-dialog.vala` - 对应new-game-dialog.vala，新游戏对话框
   - `preferences-dialog.vala` - 对应preferences-dialog.vala，首选项对话框
   - `preferences.vala` - 对应preferences.vala，设置管理

4. **AI和引擎（engine/目录）**
   - `xiangqi-engine.vala` - 对应chess-engine.vala，引擎接口
   - `xiangqi-engine-cecp.vala` - 对应chess-engine-cecp.vala，CECP协议支持
   - `xiangqi-engine-uci.vala` - 对应chess-engine-uci.vala，UCI协议支持
   - `ai-profile.vala` - 对应ai-profile.vala，AI配置文件

## 构建系统与依赖

### 构建系统
项目使用Meson构建系统，这是GNOME项目的标准构建系统。主要构建文件包括：

1. **根目录meson.build**：定义项目基本信息、版本、依赖项和子目录
2. **子目录meson.build**：定义各子目录的构建规则
3. **org.gnome.Xiangqi.json**：Flatpak打包清单

### 主要依赖项

```meson
# 在主meson.build中定义的依赖项
project('gnome-xiangqi', 'c', 'vala',
  version: '1.0.0',
  meson_version: '>= 0.50.0',
  license: 'GPL-3.0-or-later'
)

# GNOME模块
gnome = import('gnome')
i18n = import('i18n')

# 核心依赖
glib_dep = dependency('glib-2.0', version: '>= 2.44.0')
gtk_dep = dependency('gtk4', version: '>= 4.0.0')
libadwaita_dep = dependency('libadwaita-1', version: '>= 1.0.0')

# 可选依赖
librsvg_dep = dependency('librsvg-2.0', version: '>= 2.46.0')
```

### 开发环境需求

1. **编译工具**：
   - Meson构建系统（>= 0.50.0）
   - Ninja构建工具
   - Vala编译器（>= 0.48.0）
   - GCC或Clang C编译器

2. **开发库**：
   - GLib开发库（>= 2.44.0）
   - GTK 4开发库（>= 4.0.0）
   - Libadwaita开发库（>= 1.0.0）
   - librsvg开发库（>= 2.46.0）

3. **开发工具**：
   - GNOME Builder（推荐IDE）
   - Flatpak构建工具（用于打包）
   - Gettext（用于国际化）
   - appstream-util（用于验证appdata）

### 编译环境

项目在Debian 12 GNOME Builder中进行编译和测试。这是推荐的开发环境，因为它提供了完整的GNOME开发工具链和依赖项。

### 已知问题

1. **状态同步问题**：
   - 在游戏初始化和新游戏开始时，需要确保视图和游戏逻辑使用同一个状态对象
   - 解决方案：在`new_game()`调用后，通过`view.update_game_state()`方法同步状态

2. **坐标系统**：
   - 中国象棋使用的是9×10的坐标系统，与国际象棋的8×8不同
   - 确保所有坐标转换和棋子移动逻辑正确处理这一差异

### 安装指南

```bash
# 配置构建
meson setup builddir

# 编译
cd builddir
meson compile

# 安装
meson install
```

### 打包说明

项目可以使用Flatpak打包分发，org.gnome.Xiangqi.json文件定义了Flatpak清单。构建Flatpak包的命令：

```bash
flatpak-builder --user --install build-dir org.gnome.Xiangqi.json